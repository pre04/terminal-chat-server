<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Terminal Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            position: fixed;
            width: 100%;
        }
        #terminal {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        #header {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 12px;
            line-height: 1.2;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            line-height: 1.3;
            -webkit-overflow-scrolling: touch;
        }
        .message {
            margin: 3px 0;
            word-wrap: break-word;
            font-size: 14px;
            cursor: pointer;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .message:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .reactions { font-size: 14px; margin-left: 10px; }
        #emoji-picker {
            display: none;
            position: fixed;
            bottom: 60px;
            left: 10px;
            background: #111;
            border: 1px solid #00ff00;
            padding: 10px;
            font-size: 20px;
            max-width: 280px;
            z-index: 100;
        }
        #emoji-picker span { cursor: pointer; margin: 3px; display: inline-block; }
        #emoji-picker span:hover { transform: scale(1.3); }
        .user { color: #00ffff; }
        .system { color: #ffff00; }
        .status { color: #ff6b6b; }
        
        /* User color classes */
        .color-green { color: #00ff00 !important; }
        .color-cyan { color: #00ffff !important; }
        .color-yellow { color: #ffff00 !important; }
        .color-magenta { color: #ff00ff !important; }
        .color-red { color: #ff6b6b !important; }
        .color-blue { color: #6b9eff !important; }
        .color-orange { color: #ffa500 !important; }
        .color-purple { color: #9966cc !important; }
        
        /* Link styling */
        a {
            color: #88ff88 !important;
            text-decoration: underline;
        }
        a:hover {
            color: #aaffaa !important;
            text-decoration: none;
        }
        a:visited {
            color: #66dd66 !important;
        }
        #input-line {
            display: flex;
            align-items: flex-end;
            background: #111;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        #prompt { 
            color: #00ff00; 
            white-space: nowrap;
            margin-right: 5px;
        }
        #input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: inherit;
            font-size: 16px;
            outline: none;
            flex: 1;
            min-height: 20px;
            max-height: 120px;
            resize: none;
            overflow-y: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        .cursor {
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            #terminal {
                padding: 8px;
            }
            #header {
                font-size: 10px;
                margin-bottom: 8px;
            }
            .message {
                font-size: 13px;
                margin: 2px 0;
            }
            #input-line {
                padding: 10px 8px;
                position: sticky;
                bottom: 0;
            }
            #input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            #prompt {
                font-size: 12px;
            }
            #messages {
                margin-bottom: 10px;
                padding-bottom: 10px;
            }
        }
        
        /* Very small screens */
        @media (max-width: 480px) {
            #terminal {
                padding: 5px;
            }
            #header {
                font-size: 9px;
                word-break: break-all;
            }
            .message {
                font-size: 12px;
            }
            #prompt {
                font-size: 11px;
            }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            #header {
                font-size: 9px;
                margin-bottom: 5px;
            }
            #terminal {
                padding: 5px;
            }
            #input-line {
                padding: 6px;
            }
        }

        /* Image styling */
        .chat-image {
            max-width: 300px;
            max-height: 200px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            display: none;
        }
        .chat-image.expanded {
            display: block;
        }
        .chat-image:hover {
            border-color: #88ff88;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }
        .image-toggle {
            display: inline-block;
            margin-top: 5px;
            padding: 3px 8px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            color: #00ff00;
            cursor: pointer;
            font-size: 12px;
            background: transparent;
        }
        .image-toggle:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: #88ff88;
        }
        .image-toggle.hidden {
            display: none;
        }
        /* Attachment button wrapper */
        #attach-wrapper {
            position: relative;
            margin-right: 5px;
        }
        #attach-btn {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 3px;
        }
        #attach-btn:hover {
            background: #00ff00;
            color: #000;
        }
        #attach-menu {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            left: 0;
            background: #111;
            border: 1px solid #00ff00;
            border-radius: 4px;
            z-index: 200;
            min-width: 160px;
        }
        #attach-menu.open {
            display: flex;
            flex-direction: column;
        }
        .attach-option {
            background: transparent;
            border: none;
            border-bottom: 1px solid #333;
            color: #00ff00;
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap;
        }
        .attach-option:last-child {
            border-bottom: none;
        }
        .attach-option:hover {
            background: rgba(0, 255, 0, 0.15);
        }
        #image-input, #gallery-input, #video-input, #video-gallery-input {
            display: none;
        }
        /* Video styling */
        .chat-video {
            max-width: 300px;
            max-height: 200px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            margin-top: 5px;
            display: none;
        }
        .chat-video.expanded {
            display: block;
        }
        .chat-video:hover {
            border-color: #88ff88;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }
        .video-toggle {
            display: inline-block;
            margin-top: 5px;
            padding: 3px 8px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            color: #00ff00;
            cursor: pointer;
            font-size: 12px;
            background: transparent;
        }
        .video-toggle:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: #88ff88;
        }
        /* Image modal */
        #image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #image-modal img {
            max-width: 90%;
            max-height: 90%;
            border: 2px solid #00ff00;
        }
        #image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #00ff00;
            font-size: 30px;
            cursor: pointer;
        }
        #image-modal-close:hover {
            color: #ff6b6b;
        }
        /* Upload progress */
        .upload-progress {
            color: #ffff00;
            font-style: italic;
        }
        @media (max-width: 768px) {
            .chat-image, .chat-video {
                max-width: 200px;
                max-height: 150px;
            }
            #attach-btn {
                font-size: 12px;
                padding: 2px 6px;
            }
        }
        /* Voice note styling */
        #voice-btn.recording {
            background: #ff6b6b !important;
            color: #000 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .voice-toggle {
            display: inline-block;
            margin-top: 5px;
            padding: 3px 8px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            color: #00ff00;
            cursor: pointer;
            font-size: 12px;
            background: transparent;
        }
        .voice-toggle:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: #88ff88;
        }
        .chat-audio {
            display: none;
            margin-top: 5px;
            width: 100%;
            max-width: 300px;
            height: 36px;
        }
        .chat-audio.expanded {
            display: block;
        }
        /* Style audio element for terminal look */
        .chat-audio::-webkit-media-controls-panel {
            background: #111;
        }
        .chat-audio::-webkit-media-controls-play-button {
            filter: invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
        }
        #recording-indicator {
            display: none;
            color: #ff6b6b;
            font-size: 12px;
            margin-left: 5px;
            animation: pulse 1s infinite;
        }
        #recording-indicator.active {
            display: inline;
        }
        /* Custom tooltips */
        .tooltip-btn {
            position: relative;
        }
        /* Online users panel */
        #users-panel {
            display: none;
            position: fixed;
            top: 35px;
            right: 10px;
            background: #111;
            border: 1px solid #00ff00;
            border-radius: 4px;
            padding: 8px 12px;
            z-index: 150;
            min-width: 140px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        #users-panel.open { display: block; }
        #users-panel .panel-title {
            color: #ffff00;
            margin-bottom: 6px;
            font-size: 11px;
        }
        .user-entry {
            display: flex;
            align-items: center;
            margin: 4px 0;
            color: #00ff00;
            font-size: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .status-dot.online { background: #00ff00; box-shadow: 0 0 4px #00ff00; }
        .status-dot.offline { background: #ff6b6b; box-shadow: 0 0 4px #ff6b6b; }
        .inline-status-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 3px;
            vertical-align: middle;
        }
        .inline-status-dot.online { background: #00ff00; box-shadow: 0 0 3px #00ff00; }
        .inline-status-dot.offline { background: #ff6b6b; box-shadow: 0 0 3px #ff6b6b; }
        #users-btn {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            padding: 1px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        #users-btn:hover {
            background: rgba(0, 255, 0, 0.15);
        }
        .tooltip-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #111;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 4px 8px;
            font-size: 11px;
            white-space: nowrap;
            border-radius: 3px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            margin-bottom: 5px;
            z-index: 100;
        }
        .tooltip-btn:hover::after {
            opacity: 1;
        }
        /* GIF picker */
        #gif-picker {
            display: none;
            position: fixed;
            bottom: 60px;
            left: 10px;
            right: 10px;
            max-width: 400px;
            max-height: 350px;
            background: #111;
            border: 1px solid #00ff00;
            border-radius: 4px;
            z-index: 200;
            flex-direction: column;
            overflow: hidden;
        }
        #gif-picker.open {
            display: flex;
        }
        #gif-search-input {
            background: #000;
            border: none;
            border-bottom: 1px solid #333;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 8px 10px;
            outline: none;
            width: 100%;
        }
        #gif-search-input::placeholder {
            color: #555;
        }
        #gif-results {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            padding: 6px;
            overflow-y: auto;
            flex: 1;
        }
        .gif-result-item {
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
        }
        .gif-result-item:hover {
            border-color: #00ff00;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }
        .gif-result-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        #gif-loading {
            color: #ffff00;
            text-align: center;
            padding: 20px;
            font-size: 12px;
        }
        #gif-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            border-bottom: 1px solid #333;
            color: #00ff00;
            font-size: 12px;
        }
        #gif-picker-close {
            cursor: pointer;
            color: #ff6b6b;
            font-size: 16px;
        }
        #gif-picker-close:hover {
            color: #ff9999;
        }
        /* Inline GIF in chat messages */
        .chat-gif {
            max-width: 250px;
            max-height: 180px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            display: block;
        }
        .chat-gif:hover {
            border-color: #88ff88;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }
        @media (max-width: 768px) {
            .chat-gif {
                max-width: 200px;
                max-height: 150px;
            }
            #gif-picker {
                max-width: none;
                left: 5px;
                right: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="terminal">
        <div id="header">Terminal Chat v4.0 | /help for commands <button id="users-btn"><span class="status-dot online" style="display:inline-block;width:6px;height:6px;vertical-align:middle;margin-right:3px"></span><span id="users-count">0</span> online</button></div>
        <div id="users-panel">
            <div class="panel-title">Online Users</div>
            <div id="users-list"></div>
        </div>
        <div id="messages"></div>
        <div id="emoji-picker"></div>
        <div id="gif-picker">
            <div id="gif-picker-header">
                <span>üé≠ GIFs</span>
                <span id="gif-picker-close">‚úï</span>
            </div>
            <input type="text" id="gif-search-input" placeholder="Search GIFs...">
            <div id="gif-results">
                <div id="gif-loading">Loading trending GIFs...</div>
            </div>
        </div>
        <div id="input-line">
            <div id="attach-wrapper">
                <button id="attach-btn" class="tooltip-btn" data-tooltip="Attach media">üìé</button>
                <div id="attach-menu">
                    <button id="image-btn" class="attach-option">üì∑ Take Photo</button>
                    <button id="gallery-btn" class="attach-option">üñºÔ∏è Gallery</button>
                    <button id="video-btn" class="attach-option">üé¨ Record Video</button>
                    <button id="video-gallery-btn" class="attach-option">üéûÔ∏è Video Gallery</button>
                    <button id="voice-btn" class="attach-option">üé§ Voice Note</button>
                    <button id="gif-btn" class="attach-option">üé≠ Send GIF</button>
                </div>
            </div>
            <input type="file" id="image-input" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment">
            <input type="file" id="gallery-input" accept="image/jpeg,image/png,image/gif,image/webp">
            <input type="file" id="video-input" accept="video/mp4,video/quicktime,video/webm,video/*" capture="environment">
            <input type="file" id="video-gallery-input" accept="video/mp4,video/quicktime,video/webm,video/*">
            <span id="recording-indicator">REC</span>
            <span id="prompt">guest@chat:~$</span>
            <textarea id="input" placeholder="Type message..." autofocus rows="1"></textarea>
        </div>
        <div id="image-modal">
            <span id="image-modal-close">&times;</span>
            <img id="image-modal-img" src="" alt="Full size image">
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const prompt = document.getElementById('prompt');
        const emojiPicker = document.getElementById('emoji-picker');
        const attachBtn = document.getElementById('attach-btn');
        const attachMenu = document.getElementById('attach-menu');
        const imageBtn = document.getElementById('image-btn');
        const imageInput = document.getElementById('image-input');
        const galleryBtn = document.getElementById('gallery-btn');
        const galleryInput = document.getElementById('gallery-input');
        const imageModal = document.getElementById('image-modal');
        const imageModalImg = document.getElementById('image-modal-img');
        const imageModalClose = document.getElementById('image-modal-close');
        const videoBtn = document.getElementById('video-btn');
        const videoGalleryBtn = document.getElementById('video-gallery-btn');
        const videoInput = document.getElementById('video-input');
        const videoGalleryInput = document.getElementById('video-gallery-input');
        const voiceBtn = document.getElementById('voice-btn');
        const recordingIndicator = document.getElementById('recording-indicator');
        const usersBtn = document.getElementById('users-btn');
        const usersPanel = document.getElementById('users-panel');
        const usersList = document.getElementById('users-list');
        const usersCount = document.getElementById('users-count');
        const gifBtn = document.getElementById('gif-btn');
        const gifPicker = document.getElementById('gif-picker');
        const gifSearchInput = document.getElementById('gif-search-input');
        const gifResults = document.getElementById('gif-results');
        const gifPickerClose = document.getElementById('gif-picker-close');
        
        let username = localStorage.getItem('chat_username') || 'guest';
        let userColor = localStorage.getItem('chat_color') || 'cyan';
        let roomId = new URLSearchParams(window.location.search).get('room') || generateRoomId();
        let connected = false;
        let authenticated = false;
        let pendingPassword = ''; // Track password being attempted
        let isPageVisible = true;
        let notificationsEnabled = false;
        let messageReactions = JSON.parse(localStorage.getItem('reactions_' + roomId) || '{}');

        // Online users tracking
        let onlineUsers = new Set();

        // Voice recording state
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let gifSearchTimeout = null;
        
        const emojis = ['üòÄ','üòÇ','üòç','ü•∫','üò¢','üò°','üëç','üëé','‚ù§Ô∏è','üî•','üéâ','üíØ','üëÄ','üôè','üíÄ','‚ú®'];
        emojiPicker.innerHTML = emojis.map(e => `<span>${e}</span>`).join('');
        emojiPicker.onclick = (e) => {
            if (e.target.tagName === 'SPAN') {
                input.value += e.target.textContent;
                emojiPicker.style.display = 'none';
                input.focus();
            }
        };
        
        // Set initial username
        prompt.textContent = `${username}@chat:~$`;
        
        function generateRoomId() {
            const id = Math.random().toString(36).substring(2, 8);
            window.history.replaceState({}, '', `?room=${id}`);
            return id;
        }
        
        function addMessage(user, text, type = 'user', color = null, time = Date.now(), image = null, voice = null, video = null) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.dataset.time = time;

            if (type === 'user' && color) {
                msg.classList.add(`color-${color}`);
            }

            // Make URLs clickable
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const linkifiedText = text.replace(urlRegex, '<a href="$1" target="_blank" style="color: #88ff88; text-decoration: underline;">$1</a>');

            const msgId = 'msg_' + time;
            const reactions = messageReactions[msgId] || [];
            const reactionsHtml = reactions.length ? `<span class="reactions">${reactions.join('')}</span>` : '';

            // Build image HTML if present
            let imageHtml = '';
            if (image) {
                const isGif = image.endsWith('.gif') || image.includes('giphy.com') || image.includes('tenor.com') || image.includes('/media/');
                if (isGif) {
                    imageHtml = `<img class="chat-gif" src="${image}" alt="GIF">`;
                } else {
                    imageHtml = `<span class="image-toggle">[Show Image]</span><img class="chat-image" src="${image}" alt="Shared image">`;
                }
            }

            // Build voice HTML if present
            let voiceHtml = '';
            if (voice) {
                voiceHtml = `<span class="voice-toggle">[Play Voice Note]</span><audio class="chat-audio" src="${voice}" controls preload="metadata"></audio>`;
            }

            // Build video HTML if present
            let videoHtml = '';
            if (video) {
                videoHtml = `<span class="video-toggle">[Show Video]</span><video class="chat-video" src="${video}" controls preload="metadata"></video>`;
            }

            // Auto-detect GIF URLs in text and show them inline
            let autoGifHtml = '';
            const gifUrlMatch = text.match(/(https?:\/\/[^\s]+(\.gif|giphy\.com\/media|tenor\.com\/[^\s]+))/i);
            if (gifUrlMatch && !image) {
                autoGifHtml = `<img class="chat-gif" src="${gifUrlMatch[0]}" alt="GIF">`;
            }

            const statusClass = (type === 'user') ? (onlineUsers.has(user) ? 'online' : 'offline') : '';
            const statusDotHtml = (type === 'user') ? `<span class="inline-status-dot ${statusClass}" data-username="${user}"></span>` : '';
            msg.innerHTML = `<span style="color: #ff6b6b">[${new Date(time).toLocaleTimeString()}]</span> ${statusDotHtml}<span style="color: #4ecdc4">${user}:</span> ${linkifiedText}${reactionsHtml}${imageHtml}${voiceHtml}${videoHtml}${autoGifHtml}`;
            msg.onclick = (e) => {
                if (e.target.classList.contains('image-toggle')) {
                    const img = e.target.nextElementSibling;
                    const isExpanded = img.classList.toggle('expanded');
                    e.target.textContent = isExpanded ? '[Hide Image]' : '[Show Image]';
                } else if (e.target.classList.contains('voice-toggle')) {
                    const audio = e.target.nextElementSibling;
                    const isExpanded = audio.classList.toggle('expanded');
                    e.target.textContent = isExpanded ? '[Hide Voice Note]' : '[Play Voice Note]';
                    if (isExpanded) {
                        audio.play();
                    } else {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                } else if (e.target.classList.contains('video-toggle')) {
                    const vid = e.target.nextElementSibling;
                    const isExpanded = vid.classList.toggle('expanded');
                    e.target.textContent = isExpanded ? '[Hide Video]' : '[Show Video]';
                } else if (e.target.tagName === 'IMG' && e.target.classList.contains('chat-gif')) {
                    openImageModal(e.target.src);
                } else if (e.target.tagName === 'IMG' && e.target.classList.contains('chat-image')) {
                    openImageModal(e.target.src);
                } else if (e.target.tagName !== 'IMG' && !e.target.classList.contains('image-toggle') && e.target.tagName !== 'AUDIO' && !e.target.classList.contains('voice-toggle') && e.target.tagName !== 'VIDEO' && !e.target.classList.contains('video-toggle')) {
                    showReactionPicker(msgId);
                }
            };
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function openImageModal(src) {
            imageModalImg.src = src;
            imageModal.style.display = 'flex';
        }

        imageModalClose.onclick = () => {
            imageModal.style.display = 'none';
        };

        imageModal.onclick = (e) => {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        };
        
        function showReactionPicker(msgId) {
            const quickEmojis = ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•'];
            const existing = document.getElementById('reaction-picker');
            if (existing) existing.remove();
            
            const picker = document.createElement('div');
            picker.id = 'reaction-picker';
            picker.style.cssText = 'position:fixed;bottom:60px;left:10px;background:#111;border:1px solid #00ff00;padding:5px;font-size:20px;z-index:100;';
            picker.innerHTML = quickEmojis.map(e => `<span style="cursor:pointer;margin:3px">${e}</span>`).join('') + '<span style="cursor:pointer;margin:3px;color:#ff6b6b">‚úï</span>';
            picker.onclick = (e) => {
                if (e.target.tagName === 'SPAN' && e.target.textContent !== '‚úï') {
                    addReaction(msgId, e.target.textContent);
                }
                picker.remove();
            };
            document.body.appendChild(picker);
        }
        
        function addReaction(msgId, emoji) {
            if (!messageReactions[msgId]) messageReactions[msgId] = [];
            messageReactions[msgId].push(emoji);
            localStorage.setItem('reactions_' + roomId, JSON.stringify(messageReactions));
            // Refresh display
            const msgEl = document.querySelector(`[data-time="${msgId.replace('msg_','')}"]`);
            if (msgEl) {
                let reactSpan = msgEl.querySelector('.reactions');
                if (!reactSpan) {
                    reactSpan = document.createElement('span');
                    reactSpan.className = 'reactions';
                    msgEl.appendChild(reactSpan);
                }
                reactSpan.textContent = messageReactions[msgId].join('');
            }
        }
        
        function sendMessage(user, text, type = 'user', image = null, voice = null, video = null) {
            if (connected && authenticated) {
                socket.emit('send-message', {
                    roomId,
                    user,
                    text,
                    type,
                    color: type === 'user' ? userColor : null,
                    image: image,
                    voice: voice,
                    video: video
                });
            } else if (!authenticated) {
                addMessage('system', 'Please enter room password first', 'system');
            }
        }

        // Image upload handling
        async function handleImageUpload(file, inputElement) {
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                addMessage('system', 'Only images are allowed (jpeg, png, gif, webp)', 'system');
                inputElement.value = '';
                return;
            }

            // Validate file size (50MB max)
            if (file.size > 50 * 1024 * 1024) {
                addMessage('system', 'Image too large. Maximum size is 50MB.', 'system');
                inputElement.value = '';
                return;
            }

            // Show uploading message
            addMessage('system', 'Uploading image...', 'system');

            try {
                // Upload via HTTP POST
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Upload failed');
                }

                const result = await response.json();
                // Send message with image URL
                sendMessage(username, '', 'user', result.url);
            } catch (error) {
                addMessage('system', `Failed to upload image: ${error.message}`, 'system');
            }

            // Reset file input
            inputElement.value = '';
        }

        // Video upload handling
        async function handleVideoUpload(file, inputElement) {
            if (!file) return;

            // Validate file type
            const allowedTypes = ['video/mp4', 'video/webm', 'video/quicktime', 'video/3gpp', 'video/x-matroska'];
            if (!allowedTypes.includes(file.type)) {
                addMessage('system', 'Only video files are allowed (mp4, webm, mov, 3gpp, mkv)', 'system');
                inputElement.value = '';
                return;
            }

            // Validate file size (100MB max)
            if (file.size > 100 * 1024 * 1024) {
                addMessage('system', 'Video too large. Maximum size is 100MB.', 'system');
                inputElement.value = '';
                return;
            }

            // Show uploading message
            addMessage('system', 'Uploading video...', 'system');

            try {
                const formData = new FormData();
                formData.append('video', file);

                const response = await fetch('/upload-video', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Upload failed');
                }

                const result = await response.json();
                sendMessage(username, '', 'user', null, null, result.url);
            } catch (error) {
                addMessage('system', `Failed to upload video: ${error.message}`, 'system');
            }

            inputElement.value = '';
        }

        // Users panel toggle
        usersBtn.onclick = (e) => {
            e.stopPropagation();
            usersPanel.classList.toggle('open');
        };

        // Attachment menu toggle
        attachBtn.onclick = (e) => {
            e.stopPropagation();
            attachMenu.classList.toggle('open');
        };
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#attach-wrapper')) {
                attachMenu.classList.remove('open');
            }
            if (!e.target.closest('#users-panel') && !e.target.closest('#users-btn')) {
                usersPanel.classList.remove('open');
            }
            if (!e.target.closest('#gif-picker') && !e.target.closest('#gif-btn')) {
                gifPicker.classList.remove('open');
            }
        });

        imageBtn.onclick = () => { attachMenu.classList.remove('open'); imageInput.click(); };
        galleryBtn.onclick = () => { attachMenu.classList.remove('open'); galleryInput.click(); };

        imageInput.onchange = (e) => handleImageUpload(e.target.files[0], imageInput);
        galleryInput.onchange = (e) => handleImageUpload(e.target.files[0], galleryInput);

        videoBtn.onclick = () => { attachMenu.classList.remove('open'); videoInput.click(); };
        videoGalleryBtn.onclick = () => { attachMenu.classList.remove('open'); videoGalleryInput.click(); };

        videoInput.onchange = (e) => handleVideoUpload(e.target.files[0], videoInput);
        videoGalleryInput.onchange = (e) => handleVideoUpload(e.target.files[0], videoGalleryInput);

        // Voice recording handling
        voiceBtn.onclick = async () => {
            attachMenu.classList.remove('open');
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        };

        // GIF picker handling
        gifBtn.onclick = () => {
            attachMenu.classList.remove('open');
            gifPicker.classList.toggle('open');
            if (gifPicker.classList.contains('open')) {
                gifSearchInput.value = '';
                gifSearchInput.focus();
                loadGifs('');
            }
        };

        gifPickerClose.onclick = () => {
            gifPicker.classList.remove('open');
        };

        gifSearchInput.addEventListener('input', () => {
            clearTimeout(gifSearchTimeout);
            gifSearchTimeout = setTimeout(() => {
                loadGifs(gifSearchInput.value.trim());
            }, 300);
        });

        async function loadGifs(query) {
            gifResults.innerHTML = '<div id="gif-loading">Searching...</div>';
            try {
                const endpoint = query 
                    ? `/api/gifs?q=${encodeURIComponent(query)}&limit=20`
                    : `/api/gifs/trending?limit=20`;
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (!data.gifs || data.gifs.length === 0) {
                    gifResults.innerHTML = '<div id="gif-loading">No GIFs found</div>';
                    return;
                }
                
                gifResults.innerHTML = '';
                data.gifs.forEach(gif => {
                    const item = document.createElement('div');
                    item.className = 'gif-result-item';
                    item.innerHTML = `<img src="${gif.preview}" alt="${gif.title}" loading="lazy">`;
                    item.onclick = () => {
                        sendMessage(username, '', 'user', gif.url);
                        gifPicker.classList.remove('open');
                    };
                    gifResults.appendChild(item);
                });
            } catch (error) {
                gifResults.innerHTML = '<div id="gif-loading">Failed to load GIFs</div>';
                console.error('GIF load error:', error);
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Determine best supported format
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                    mimeType = 'audio/ogg';
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    if (audioChunks.length === 0) {
                        addMessage('system', 'No audio recorded', 'system');
                        return;
                    }

                    const audioBlob = new Blob(audioChunks, { type: mimeType });

                    // Check size (20MB max)
                    if (audioBlob.size > 20 * 1024 * 1024) {
                        addMessage('system', 'Voice note too large. Maximum size is 20MB.', 'system');
                        return;
                    }

                    // Upload the voice note
                    addMessage('system', 'Uploading voice note...', 'system');

                    try {
                        const formData = new FormData();
                        // Determine file extension from mime type
                        let ext = '.webm';
                        if (mimeType.includes('mp4') || mimeType.includes('m4a')) ext = '.m4a';
                        else if (mimeType.includes('ogg')) ext = '.ogg';

                        formData.append('voice', audioBlob, `voice${ext}`);

                        const response = await fetch('/upload-voice', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Upload failed');
                        }

                        const result = await response.json();
                        sendMessage(username, '', 'user', null, result.url);
                    } catch (error) {
                        addMessage('system', `Failed to upload voice note: ${error.message}`, 'system');
                    }
                };

                mediaRecorder.start(100); // Collect data every 100ms
                isRecording = true;
                voiceBtn.classList.add('recording');
                recordingIndicator.classList.add('active');
                addMessage('system', 'Recording... Tap üé§ again to stop', 'system');

            } catch (error) {
                console.error('Microphone access error:', error);
                if (error.name === 'NotAllowedError') {
                    addMessage('system', 'Microphone access denied. Please allow microphone access in your browser settings.', 'system');
                } else if (error.name === 'NotFoundError') {
                    addMessage('system', 'No microphone found. Please connect a microphone.', 'system');
                } else {
                    addMessage('system', `Could not access microphone: ${error.message}`, 'system');
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
            voiceBtn.classList.remove('recording');
            recordingIndicator.classList.remove('active');
        }

        function joinRoom(password = '') {
            if (connected) {
                pendingPassword = password;
                socket.emit('join-room', { roomId, password, username, color: userColor });
            }
        }
        
        // Socket events
        socket.on('connect', () => {
            connected = true;
            // Try stored password first, otherwise join without password
            const storedPassword = localStorage.getItem('chat_password_' + roomId) || '';
            joinRoom(storedPassword);
            addMessage('system', `Connecting to room: ${roomId}`, 'system');
        });
        
        socket.on('auth-success', () => {
            authenticated = true;
            // Store successful password for auto-reconnect
            if (pendingPassword) {
                localStorage.setItem('chat_password_' + roomId, pendingPassword);
            }
            addMessage('system', `Connected to room: ${roomId}`, 'system');
            if (username !== 'guest') {
                addMessage('system', `Nickname restored: ${username}`, 'system');
            }
            addMessage('system', `Share URL: ${window.location.href}`, 'system');
        });
        
        socket.on('auth-failed', (message) => {
            authenticated = false;
            // Clear stored password since it's wrong
            localStorage.removeItem('chat_password_' + roomId);
            addMessage('system', `Access denied: ${message}`, 'system');
            addMessage('system', 'Use /password <password> to enter room', 'system');
        });
        
        socket.on('password-set', (message) => {
            addMessage('system', message, 'system');
        });
        
        socket.on('password-failed', (message) => {
            addMessage('system', message, 'system');
        });
        
        socket.on('disconnect', () => {
            connected = false;
            addMessage('system', 'Disconnected from server', 'status');
        });
        
        socket.on('load-messages', (roomMessages) => {
            roomMessages.forEach(msg => {
                addMessage(msg.user, msg.text, msg.type, msg.color, msg.time, msg.image, msg.voice, msg.video);
            });
        });

        socket.on('new-message', (message) => {
            addMessage(message.user, message.text, message.type, message.color, message.time, message.image, message.voice, message.video);
            
            // Debug logging
            console.log('New message:', message.user, 'Current user:', username, 'Page visible:', isPageVisible, 'Notifications enabled:', notificationsEnabled);
            
            // Show notification if page is not visible and it's not from current user
            if (!isPageVisible && message.user !== username && message.type === 'user' && notificationsEnabled) {
                console.log('Showing notification for:', message.user, message.text);
                showNotification(message.user, message.text);
            }
        });
        
        socket.on('chat-deleted', () => {
            messages.innerHTML = '';
            addMessage('system', 'Chat history deleted by user', 'system');
        });

        socket.on('user-list', (users) => {
            usersCount.textContent = users.length;
            usersList.innerHTML = users.map(u =>
                `<div class="user-entry"><span class="status-dot online"></span><span class="color-${u.color || 'cyan'}">${u.username}</span></div>`
            ).join('');

            // Update online users set and refresh inline status dots
            onlineUsers = new Set(users.map(u => u.username));
            document.querySelectorAll('.inline-status-dot').forEach(dot => {
                const name = dot.dataset.username;
                dot.classList.toggle('online', onlineUsers.has(name));
                dot.classList.toggle('offline', !onlineUsers.has(name));
            });
        });
        
        // Input handling with mobile support
        input.addEventListener('focus', () => {
            setTimeout(() => {
                messages.scrollTop = messages.scrollHeight;
            }, 100);
        });
        
        // Handle mobile keyboard resize
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.getElementById('terminal').style.height = window.visualViewport.height + 'px';
                messages.scrollTop = messages.scrollHeight;
            });
        }
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (input.value.trim()) {
                    handleMessage(input.value.trim());
                    input.value = '';
                    input.style.height = 'auto';
                }
            }
        });

        input.addEventListener('input', () => {
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
        });
        
        // Add send button for mobile (invisible but functional)
        const sendButton = document.createElement('button');
        sendButton.style.display = 'none';
        sendButton.onclick = () => {
            if (input.value.trim()) {
                handleMessage(input.value.trim());
                input.value = '';
            }
        };
        document.body.appendChild(sendButton);
        
        // Handle form submission on mobile
        input.addEventListener('blur', () => {
            // Small delay to allow for button clicks
            setTimeout(() => input.focus(), 100);
        });
        
        async function handleMessage(text) {
            if (text.startsWith('/nick ')) {
                const newNick = text.substring(6).trim();
                if (!newNick) {
                    addMessage('system', 'Usage: /nick <name>', 'system');
                    return;
                }
                username = newNick;
                localStorage.setItem('chat_username', username);
                prompt.textContent = `${username}@chat:~$`;
                socket.emit('update-user', { username, color: userColor });
                sendMessage('system', `${username} joined the chat`, 'system');
            } else if (text.startsWith('/color ')) {
                const newColor = text.substring(7).toLowerCase();
                const validColors = ['green', 'cyan', 'yellow', 'magenta', 'red', 'blue', 'orange', 'purple'];

                if (validColors.includes(newColor)) {
                    userColor = newColor;
                    localStorage.setItem('chat_color', userColor);
                    socket.emit('update-user', { username, color: userColor });
                    addMessage('system', `Color changed to ${newColor}`, 'system');
                } else {
                    addMessage('system', `Available colors: ${validColors.join(', ')}`, 'system');
                }
            } else if (text.startsWith('/password ')) {
                const password = text.substring(10);
                joinRoom(password);
            } else if (text.startsWith('/setpass ')) {
                const password = text.substring(9);
                if (connected) {
                    socket.emit('set-password', { roomId, password });
                }
            } else if (text === '/clear') {
                messages.innerHTML = '';
            } else if (text === '/room') {
                addMessage('system', `Current room: ${roomId}`, 'system');
                addMessage('system', `Share URL: ${window.location.href}`, 'system');
                addMessage('system', `Authenticated: ${authenticated ? 'Yes' : 'No'}`, 'system');
            } else if (text === '/notify') {
                requestNotificationPermission();
            } else if (text === '/copy') {
                copyAllMessages();
            } else if (text === '/help') {
                addMessage('system', 'Commands:', 'system');
                addMessage('system', '/nick <name> - Change username', 'system');
                addMessage('system', '/color <color> - Change text color', 'system');
                addMessage('system', '/emoji - Toggle emoji picker', 'system');
                addMessage('system', '/gif <search> - Search and send animated GIF', 'system');
                addMessage('system', '/password <pass> - Enter room password', 'system');
                addMessage('system', '/setpass <pass> - Set room password (empty rooms only)', 'system');
                addMessage('system', '/notify - Enable desktop notifications', 'system');
                addMessage('system', '/copy - Copy all chat messages', 'system');
                addMessage('system', '/users - Toggle online users panel', 'system');
                addMessage('system', '/clear - Clear chat', 'system');
                addMessage('system', '/room - Show room info', 'system');
                addMessage('system', 'Tap any message to add reaction', 'system');
                addMessage('system', 'Colors: green, cyan, yellow, magenta, red, blue, orange, purple', 'system');
            } else if (text === '/users') {
                usersPanel.classList.toggle('open');
            } else if (text === '/emoji') {
                emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
            } else if (text.startsWith('/gif ') || text === '/gif') {
                const query = text.substring(5).trim();
                if (!query) {
                    // Open the GIF picker if no query
                    gifPicker.classList.toggle('open');
                    if (gifPicker.classList.contains('open')) {
                        gifSearchInput.value = '';
                        gifSearchInput.focus();
                        loadGifs('');
                    }
                } else {
                    // Search and send first result
                    try {
                        const response = await fetch(`/api/gifs?q=${encodeURIComponent(query)}&limit=1`);
                        const data = await response.json();
                        if (data.gifs && data.gifs.length > 0) {
                            sendMessage(username, '', 'user', data.gifs[0].url);
                        } else {
                            addMessage('system', `No GIFs found for "${query}"`, 'system');
                        }
                    } catch (error) {
                        addMessage('system', 'Failed to search GIFs', 'system');
                    }
                }
            } else {
                sendMessage(username, text);
            }
        }
        
        function copyAllMessages() {
            const messageElements = messages.querySelectorAll('.message');
            let chatText = '';
            
            messageElements.forEach(msg => {
                // Extract text content without HTML tags
                const textContent = msg.textContent || msg.innerText;
                chatText += textContent + '\n';
            });
            
            if (chatText.trim()) {
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(chatText.trim()).then(() => {
                        addMessage('system', 'Chat copied to clipboard!', 'system');
                    }).catch(() => {
                        fallbackCopy(chatText.trim());
                    });
                } else {
                    fallbackCopy(chatText.trim());
                }
            } else {
                addMessage('system', 'No messages to copy', 'system');
            }
        }
        
        function fallbackCopy(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    addMessage('system', 'Chat copied to clipboard!', 'system');
                } else {
                    showCopyModal(text);
                }
            } catch (err) {
                showCopyModal(text);
            }
        }
        
        function showCopyModal(text) {
            // Create modal for manual copy
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: #111; border: 2px solid #00ff00; padding: 20px;
                max-width: 80%; max-height: 80%; overflow: auto;
                font-family: 'Courier New', monospace; color: #00ff00;
            `;
            
            const title = document.createElement('div');
            title.textContent = 'Copy Chat (Select All & Copy):';
            title.style.cssText = 'margin-bottom: 10px; color: #ffff00;';
            
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.cssText = `
                width: 100%; height: 300px; background: #000; color: #00ff00;
                border: 1px solid #333; font-family: 'Courier New', monospace;
                font-size: 12px; padding: 10px;
            `;
            textArea.readOnly = true;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = `
                margin-top: 10px; background: #333; color: #00ff00;
                border: 1px solid #00ff00; padding: 5px 15px;
                font-family: 'Courier New', monospace; cursor: pointer;
            `;
            
            closeBtn.onclick = () => document.body.removeChild(modal);
            modal.onclick = (e) => { if (e.target === modal) document.body.removeChild(modal); };
            
            content.appendChild(title);
            content.appendChild(textArea);
            content.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Auto-select text
            textArea.select();
            textArea.focus();
        }
        
        // Notification functions
        function requestNotificationPermission() {
            console.log('Requesting notification permission...');
            
            if (!('Notification' in window)) {
                addMessage('system', 'Browser does not support notifications', 'system');
                return;
            }
            
            console.log('Current permission:', Notification.permission);
            
            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                addMessage('system', 'Notifications already enabled!', 'system');
                // Test notification immediately
                showTestNotification();
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    console.log('Permission result:', permission);
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        addMessage('system', 'Notifications enabled! You\'ll get alerts when tab is not visible', 'system');
                        showTestNotification();
                    } else {
                        addMessage('system', 'Notifications denied', 'system');
                    }
                });
            } else {
                addMessage('system', 'Notifications blocked. Enable in browser settings.', 'system');
            }
        }
        
        function showTestNotification() {
            try {
                playNotificationSound();
                
                const notification = new Notification('Terminal Chat Test', {
                    body: 'Notifications are working! You\'ll get alerts for new messages.',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzAwZmYwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+SrDwvdGV4dD4KPHN2Zz4=',
                    tag: 'terminal-chat-test',
                    silent: false
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                setTimeout(() => notification.close(), 3000);
            } catch (error) {
                console.error('Test notification failed:', error);
                addMessage('system', 'Test notification failed: ' + error.message, 'system');
            }
        }
        
        function showNotification(user, text) {
            console.log('showNotification called:', user, text, 'Permission:', Notification.permission);
            
            if (notificationsEnabled && Notification.permission === 'granted') {
                try {
                    playNotificationSound();
                    
                    const notification = new Notification(`üí¨ ${user}`, {
                        body: text.length > 100 ? text.substring(0, 100) + '...' : text,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzAwZmYwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+SrDwvdGV4dD4KPHN2Zz4=',
                        tag: 'terminal-chat',
                        requireInteraction: false,
                        silent: false
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                    
                    // Auto-close after 5 seconds
                    setTimeout(() => notification.close(), 5000);
                    console.log('Notification created successfully');
                } catch (error) {
                    console.error('Notification failed:', error);
                    addMessage('system', 'Notification error: ' + error.message, 'system');
                }
            } else {
                console.log('Notification not shown - enabled:', notificationsEnabled, 'permission:', Notification.permission);
            }
        }
        
        function playNotificationSound() {
            try {
                // Create a simple beep sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
                console.log('Notification sound played');
            } catch (error) {
                console.log('Could not play notification sound:', error);
                // Fallback: try to play a simple audio element
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                    audio.volume = 0.3;
                    audio.play();
                } catch (e) {
                    console.log('Audio fallback also failed:', e);
                }
            }
        }
        
        // Page visibility detection
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
            console.log('Page visibility changed:', isPageVisible);
        });
        
        window.addEventListener('focus', () => {
            isPageVisible = true;
            console.log('Window focused');
        });
        
        window.addEventListener('blur', () => {
            isPageVisible = false;
            console.log('Window blurred');
        });
        
        // Prevent zoom on iOS
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });
        
        // Keep input focused on mobile
        input.addEventListener('touchend', () => {
            input.focus();
        });
        
        // Initial message
        addMessage('system', 'Commands: /nick, /color, /notify, /copy, /help', 'system');
    </script>
</body>
</html>
