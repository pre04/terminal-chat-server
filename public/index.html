<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            height: 100dvh;
            overflow: hidden;
        }
        #terminal {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        #header {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 12px;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            line-height: 1.4;
            padding-bottom: 20px;
        }
        .message {
            margin: 5px 0;
            word-wrap: break-word;
            cursor: pointer;
        }
        .message:hover { background: #111; }
        .reactions { font-size: 14px; margin-left: 10px; }
        .reactions span { margin-right: 5px; cursor: pointer; }
        .reactions span:hover { transform: scale(1.2); display: inline-block; }
        #emoji-picker {
            display: none;
            position: fixed;
            bottom: 60px;
            left: 10px;
            background: #111;
            border: 1px solid #00ff00;
            padding: 10px;
            font-size: 20px;
            max-width: 280px;
            z-index: 100;
        }
        #emoji-picker span { cursor: pointer; margin: 3px; display: inline-block; }
        #emoji-picker span:hover { transform: scale(1.3); }
        .user { color: #00ffff; }
        .system { color: #ffff00; }
        #input-line {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            padding-bottom: 10px;
        }
        #prompt { color: #00ff00; font-size: 12px; }
        #input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: inherit;
            font-size: 16px;
            outline: none;
            flex: 1;
            margin-left: 5px;
        }
        .cursor {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="terminal">
        <div id="header">Terminal Chat v2.5 - Local demo | For real chat, need backend server</div>
        <div id="messages"></div>
        <div id="emoji-picker"></div>
        <div id="input-line">
            <span id="prompt">guest@chat:~$</span>
            <input type="text" id="input" placeholder="Type message..." autofocus>
            <span class="cursor">_</span>
        </div>
    </div>

    <script>
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const prompt = document.getElementById('prompt');
        const emojiPicker = document.getElementById('emoji-picker');
        
        const emojis = ['ðŸ˜€','ðŸ˜‚','ðŸ˜','ðŸ¥º','ðŸ˜¢','ðŸ˜¡','ðŸ‘','ðŸ‘Ž','â¤ï¸','ðŸ”¥','ðŸŽ‰','ðŸ’¯','ðŸ‘€','ðŸ™','ðŸ’€','âœ¨'];
        emojiPicker.innerHTML = emojis.map(e => `<span onclick="insertEmoji('${e}')">${e}</span>`).join('');
        
        let messageReactions = JSON.parse(localStorage.getItem('reactions_' + location.search) || '{}');
        let userColor = localStorage.getItem('chat_color') || '#00ff00';
        
        let username = localStorage.getItem('chat_username') || 'guest';
        let roomId = new URLSearchParams(window.location.search).get('room') || generateRoomId();
        
        // Set initial username
        prompt.textContent = `${username}@chat:~$`;
        
        function generateRoomId() {
            const id = Math.random().toString(36).substring(2, 8);
            window.history.replaceState({}, '', `?room=${id}`);
            return id;
        }
        
        function addMessage(user, text, type = 'user', time = Date.now(), msgId = null, color = null) {
            const id = msgId || 'msg_' + time;
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.dataset.id = id;
            const reactions = messageReactions[id] || [];
            const reactionsHtml = reactions.length ? `<span class="reactions">${reactions.join('')}</span>` : '';
            const textColor = color || '#00ff00';
            msg.innerHTML = `<span style="color: #ff6b6b">[${new Date(time).toLocaleTimeString()}]</span> <span style="color: #4ecdc4">${user}:</span> <span style="color:${textColor}">${text}</span>${reactionsHtml}`;
            msg.onclick = () => showReactionPicker(id);
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function showReactionPicker(msgId) {
            const quickEmojis = ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ”¥'];
            const picker = document.createElement('div');
            picker.style.cssText = 'position:fixed;bottom:60px;left:10px;background:#111;border:1px solid #00ff00;padding:5px;font-size:20px;z-index:100;';
            picker.innerHTML = quickEmojis.map(e => `<span style="cursor:pointer;margin:3px">${e}</span>`).join('') + '<span style="cursor:pointer;margin:3px;color:#ff6b6b">âœ•</span>';
            picker.onclick = (e) => {
                if (e.target.tagName === 'SPAN' && e.target.textContent !== 'âœ•') {
                    addReaction(msgId, e.target.textContent);
                }
                picker.remove();
            };
            document.body.appendChild(picker);
        }
        
        function addReaction(msgId, emoji) {
            if (!messageReactions[msgId]) messageReactions[msgId] = [];
            messageReactions[msgId].push(emoji);
            localStorage.setItem('reactions_' + location.search, JSON.stringify(messageReactions));
            refreshMessages();
        }
        
        function refreshMessages() {
            const chatKey = `chat_${roomId}`;
            const chatData = JSON.parse(localStorage.getItem(chatKey) || '[]');
            messages.innerHTML = '';
            chatData.forEach(msg => addMessage(msg.user, msg.text, msg.type, msg.time, 'msg_' + msg.time));
        }
        
        function insertEmoji(emoji) {
            input.value += emoji;
            emojiPicker.style.display = 'none';
            input.focus();
        }
        
        function saveToLocal(user, text, type = 'user', time = Date.now(), color = null) {
            const chatKey = `chat_${roomId}`;
            let chatData = JSON.parse(localStorage.getItem(chatKey) || '[]');
            chatData.push({
                user,
                text,
                type,
                time,
                color
            });
            // Keep only last 50 messages
            if (chatData.length > 50) {
                chatData = chatData.slice(-50);
            }
            localStorage.setItem(chatKey, JSON.stringify(chatData));
        }
        
        function loadFromLocal() {
            const chatKey = `chat_${roomId}`;
            const chatData = JSON.parse(localStorage.getItem(chatKey) || '[]');
            chatData.forEach(msg => {
                addMessage(msg.user, msg.text, msg.type, msg.time, 'msg_' + msg.time, msg.color);
            });
        }
        
        async function sendMessage(user, text, type = 'user') {
            const time = Date.now();
            const color = type === 'user' ? userColor : null;
            
            // Show message immediately
            addMessage(user, text, type, time, null, color);
            
            // Save locally
            saveToLocal(user, text, type, time, color);
            
            // Try to broadcast via simple HTTP request (for demo purposes)
            try {
                const messageData = {
                    room: roomId,
                    user,
                    text,
                    type,
                    time: Date.now()
                };
                
                // Use httpbin.org to simulate message sending
                await fetch('https://httpbin.org/post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });
                
                console.log('Message broadcasted');
            } catch (e) {
                console.log('Broadcast failed, message saved locally');
            }
        }
        
        input.addEventListener('focus', () => {
            setTimeout(() => messages.scrollTop = messages.scrollHeight, 300);
        });
        
        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                const text = input.value.trim();
                
                if (text.startsWith('/nick ')) {
                    username = text.substring(6);
                    localStorage.setItem('chat_username', username);
                    prompt.textContent = `${username}@chat:~$`;
                    await sendMessage('system', `${username} joined the chat`, 'system');
                } else if (text === '/clear') {
                    messages.innerHTML = '';
                    addMessage('system', `Room: ${roomId} | Share URL to chat`, 'system');
                    addMessage('system', `URL: ${window.location.href}`, 'system');
                } else if (text === '/room') {
                    addMessage('system', `Current room: ${roomId}`, 'system');
                    addMessage('system', `Share URL: ${window.location.href}`, 'system');
                } else if (text === '/help') {
                    addMessage('system', 'Commands:', 'system');
                    addMessage('system', '  /nick <name> - Set your username', 'system');
                    addMessage('system', '  /color <hex> - Set message color (e.g. /color #ff0000)', 'system');
                    addMessage('system', '  /emoji - Toggle emoji picker', 'system');
                    addMessage('system', '  /room - Show room info and share URL', 'system');
                    addMessage('system', '  /clear - Clear chat display', 'system');
                    addMessage('system', '  /delete - Delete all messages in room', 'system');
                    addMessage('system', 'Tap any message to add a reaction.', 'system');
                } else if (text === '/emoji') {
                    emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
                } else if (text.startsWith('/color ')) {
                    userColor = text.substring(7).trim();
                    localStorage.setItem('chat_color', userColor);
                    addMessage('system', `Message color set to ${userColor}`, 'system');
                } else if (text === '/delete') {
                    localStorage.removeItem(`chat_${roomId}`);
                    localStorage.removeItem('reactions_' + location.search);
                    messageReactions = {};
                    messages.innerHTML = '';
                    addMessage('system', 'Chat deleted.', 'system');
                } else {
                    await sendMessage(username, text);
                }
                
                input.value = '';
            }
        });
        
        // Load existing messages
        loadFromLocal();
    </script>
</body>
</html>
