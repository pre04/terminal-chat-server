<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            height: 100dvh;
            overflow: hidden;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        #terminal {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        #header {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 12px;
            line-height: 1.2;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            line-height: 1.3;
            -webkit-overflow-scrolling: touch;
        }
        .message {
            margin: 3px 0;
            word-wrap: break-word;
            font-size: 14px;
            cursor: pointer;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .message:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .reactions { font-size: 14px; margin-left: 10px; }
        #emoji-picker {
            display: none;
            position: fixed;
            bottom: 60px;
            left: 10px;
            background: #111;
            border: 1px solid #00ff00;
            padding: 10px;
            font-size: 20px;
            max-width: 280px;
            z-index: 100;
        }
        #emoji-picker span { cursor: pointer; margin: 3px; display: inline-block; }
        #emoji-picker span:hover { transform: scale(1.3); }
        .user { color: #00ffff; }
        .system { color: #ffff00; }
        .status { color: #ff6b6b; }
        
        /* User color classes */
        .color-green { color: #00ff00 !important; }
        .color-cyan { color: #00ffff !important; }
        .color-yellow { color: #ffff00 !important; }
        .color-magenta { color: #ff00ff !important; }
        .color-red { color: #ff6b6b !important; }
        .color-blue { color: #6b9eff !important; }
        .color-orange { color: #ffa500 !important; }
        .color-purple { color: #9966cc !important; }
        
        /* Link styling */
        a {
            color: #88ff88 !important;
            text-decoration: underline;
        }
        a:hover {
            color: #aaffaa !important;
            text-decoration: none;
        }
        a:visited {
            color: #66dd66 !important;
        }
        #input-line {
            display: flex;
            align-items: center;
            background: #111;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        #prompt { 
            color: #00ff00; 
            white-space: nowrap;
            margin-right: 5px;
        }
        #input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: inherit;
            font-size: 16px;
            outline: none;
            flex: 1;
            min-height: 20px;
        }
        .cursor {
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            #terminal {
                padding: 8px;
            }
            #header {
                font-size: 10px;
                margin-bottom: 8px;
            }
            .message {
                font-size: 13px;
                margin: 2px 0;
            }
            #input-line {
                padding: 10px 8px;
                position: sticky;
                bottom: 0;
            }
            #input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            #prompt {
                font-size: 12px;
            }
            #messages {
                margin-bottom: 10px;
                padding-bottom: 10px;
            }
        }
        
        /* Very small screens */
        @media (max-width: 480px) {
            #terminal {
                padding: 5px;
            }
            #header {
                font-size: 9px;
                word-break: break-all;
            }
            .message {
                font-size: 12px;
            }
            #prompt {
                font-size: 11px;
            }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            #header {
                font-size: 9px;
                margin-bottom: 5px;
            }
            #terminal {
                padding: 5px;
            }
            #input-line {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div id="terminal">
        <div id="header">Terminal Chat v3.8 - Sound Notifications | /notify enables visual + audio alerts</div>
        <div id="messages"></div>
        <div id="emoji-picker"></div>
        <div id="input-line">
            <span id="prompt">guest@chat:~$</span>
            <input type="text" id="input" placeholder="Type message..." autofocus>
            <span class="cursor">_</span>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const prompt = document.getElementById('prompt');
        const emojiPicker = document.getElementById('emoji-picker');
        
        let username = localStorage.getItem('chat_username') || 'guest';
        let userColor = localStorage.getItem('chat_color') || 'cyan';
        let roomId = new URLSearchParams(window.location.search).get('room') || generateRoomId();
        let connected = false;
        let authenticated = false;
        let isPageVisible = true;
        let notificationsEnabled = false;
        let messageReactions = JSON.parse(localStorage.getItem('reactions_' + roomId) || '{}');
        
        const emojis = ['ðŸ˜€','ðŸ˜‚','ðŸ˜','ðŸ¥º','ðŸ˜¢','ðŸ˜¡','ðŸ‘','ðŸ‘Ž','â¤ï¸','ðŸ”¥','ðŸŽ‰','ðŸ’¯','ðŸ‘€','ðŸ™','ðŸ’€','âœ¨'];
        emojiPicker.innerHTML = emojis.map(e => `<span onclick="insertEmoji('${e}')">${e}</span>`).join('');
        
        // Set initial username
        prompt.textContent = `${username}@chat:~$`;
        
        function generateRoomId() {
            const id = Math.random().toString(36).substring(2, 8);
            window.history.replaceState({}, '', `?room=${id}`);
            return id;
        }
        
        function addMessage(user, text, type = 'user', color = null, time = Date.now()) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.dataset.time = time;
            
            if (type === 'user' && color) {
                msg.classList.add(`color-${color}`);
            }
            
            // Make URLs clickable
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const linkifiedText = text.replace(urlRegex, '<a href="$1" target="_blank" style="color: #88ff88; text-decoration: underline;">$1</a>');
            
            const msgId = 'msg_' + time;
            const reactions = messageReactions[msgId] || [];
            const reactionsHtml = reactions.length ? `<span class="reactions">${reactions.join('')}</span>` : '';
            
            msg.innerHTML = `<span style="color: #ff6b6b">[${new Date(time).toLocaleTimeString()}]</span> <span style="color: #4ecdc4">${user}:</span> ${linkifiedText}${reactionsHtml}`;
            msg.onclick = () => showReactionPicker(msgId);
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function showReactionPicker(msgId) {
            const quickEmojis = ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ”¥'];
            const existing = document.getElementById('reaction-picker');
            if (existing) existing.remove();
            
            const picker = document.createElement('div');
            picker.id = 'reaction-picker';
            picker.style.cssText = 'position:fixed;bottom:60px;left:10px;background:#111;border:1px solid #00ff00;padding:5px;font-size:20px;z-index:100;';
            picker.innerHTML = quickEmojis.map(e => `<span style="cursor:pointer;margin:3px">${e}</span>`).join('') + '<span style="cursor:pointer;margin:3px;color:#ff6b6b">âœ•</span>';
            picker.onclick = (e) => {
                if (e.target.tagName === 'SPAN' && e.target.textContent !== 'âœ•') {
                    addReaction(msgId, e.target.textContent);
                }
                picker.remove();
            };
            document.body.appendChild(picker);
        }
        
        function addReaction(msgId, emoji) {
            if (!messageReactions[msgId]) messageReactions[msgId] = [];
            messageReactions[msgId].push(emoji);
            localStorage.setItem('reactions_' + roomId, JSON.stringify(messageReactions));
            // Refresh display
            const msgEl = document.querySelector(`[data-time="${msgId.replace('msg_','')}"]`);
            if (msgEl) {
                let reactSpan = msgEl.querySelector('.reactions');
                if (!reactSpan) {
                    reactSpan = document.createElement('span');
                    reactSpan.className = 'reactions';
                    msgEl.appendChild(reactSpan);
                }
                reactSpan.textContent = messageReactions[msgId].join('');
            }
        }
        
        function insertEmoji(emoji) {
            input.value += emoji;
            document.getElementById('emoji-picker').style.display = 'none';
            input.focus();
        }

        function sendMessage(user, text, type = 'user') {
            if (connected && authenticated) {
                socket.emit('send-message', {
                    roomId,
                    user,
                    text,
                    type,
                    color: type === 'user' ? userColor : null
                });
            } else if (!authenticated) {
                addMessage('system', 'Please enter room password first', 'system');
            }
        }
        
        function joinRoom(password = '') {
            if (connected) {
                socket.emit('join-room', { roomId, password });
            }
        }
        
        // Socket events
        socket.on('connect', () => {
            connected = true;
            joinRoom(); // Try to join without password first
            addMessage('system', `Connecting to room: ${roomId}`, 'system');
        });
        
        socket.on('auth-success', () => {
            authenticated = true;
            addMessage('system', `Connected to room: ${roomId}`, 'system');
            addMessage('system', `Share URL: ${window.location.href}`, 'system');
        });
        
        socket.on('auth-failed', (message) => {
            authenticated = false;
            addMessage('system', `Access denied: ${message}`, 'system');
            addMessage('system', 'Use /password <password> to enter room', 'system');
        });
        
        socket.on('password-set', (message) => {
            addMessage('system', message, 'system');
        });
        
        socket.on('password-failed', (message) => {
            addMessage('system', message, 'system');
        });
        
        socket.on('disconnect', () => {
            connected = false;
            addMessage('system', 'Disconnected from server', 'status');
        });
        
        socket.on('load-messages', (roomMessages) => {
            roomMessages.forEach(msg => {
                addMessage(msg.user, msg.text, msg.type, msg.color, msg.time);
            });
        });
        
        socket.on('new-message', (message) => {
            addMessage(message.user, message.text, message.type, message.color, message.time);
            
            // Debug logging
            console.log('New message:', message.user, 'Current user:', username, 'Page visible:', isPageVisible, 'Notifications enabled:', notificationsEnabled);
            
            // Show notification if page is not visible and it's not from current user
            if (!isPageVisible && message.user !== username && message.type === 'user' && notificationsEnabled) {
                console.log('Showing notification for:', message.user, message.text);
                showNotification(message.user, message.text);
            }
        });
        
        socket.on('chat-deleted', () => {
            messages.innerHTML = '';
            addMessage('system', 'Chat history deleted by user', 'system');
        });
        
        // Input handling with mobile support
        input.addEventListener('focus', () => {
            setTimeout(() => messages.scrollTop = messages.scrollHeight, 300);
        });
        
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                handleMessage(input.value.trim());
                input.value = '';
            }
        });
        
        // Add send button for mobile (invisible but functional)
        const sendButton = document.createElement('button');
        sendButton.style.display = 'none';
        sendButton.onclick = () => {
            if (input.value.trim()) {
                handleMessage(input.value.trim());
                input.value = '';
            }
        };
        document.body.appendChild(sendButton);
        
        // Handle form submission on mobile
        input.addEventListener('blur', () => {
            // Small delay to allow for button clicks
            setTimeout(() => input.focus(), 100);
        });
        
        function handleMessage(text) {
            if (text.startsWith('/nick ')) {
                username = text.substring(6);
                localStorage.setItem('chat_username', username);
                prompt.textContent = `${username}@chat:~$`;
                sendMessage('system', `${username} joined the chat`, 'system');
            } else if (text.startsWith('/color ')) {
                const newColor = text.substring(7).toLowerCase();
                const validColors = ['green', 'cyan', 'yellow', 'magenta', 'red', 'blue', 'orange', 'purple'];
                
                if (validColors.includes(newColor)) {
                    userColor = newColor;
                    localStorage.setItem('chat_color', userColor);
                    addMessage('system', `Color changed to ${newColor}`, 'system');
                } else {
                    addMessage('system', `Available colors: ${validColors.join(', ')}`, 'system');
                }
            } else if (text.startsWith('/password ')) {
                const password = text.substring(10);
                joinRoom(password);
            } else if (text.startsWith('/setpass ')) {
                const password = text.substring(9);
                if (connected) {
                    socket.emit('set-password', { roomId, password });
                }
            } else if (text === '/clear') {
                messages.innerHTML = '';
            } else if (text === '/delete') {
                if (connected && authenticated) {
                    socket.emit('delete-chat', { roomId });
                } else {
                    addMessage('system', 'Must be connected to delete chat', 'system');
                }
            } else if (text === '/room') {
                addMessage('system', `Current room: ${roomId}`, 'system');
                addMessage('system', `Share URL: ${window.location.href}`, 'system');
                addMessage('system', `Authenticated: ${authenticated ? 'Yes' : 'No'}`, 'system');
            } else if (text === '/notify') {
                requestNotificationPermission();
            } else if (text === '/copy') {
                copyAllMessages();
            } else if (text === '/help') {
                addMessage('system', 'Commands:', 'system');
                addMessage('system', '/nick <name> - Change username', 'system');
                addMessage('system', '/color <color> - Change text color', 'system');
                addMessage('system', '/emoji - Toggle emoji picker', 'system');
                addMessage('system', '/password <pass> - Enter room password', 'system');
                addMessage('system', '/setpass <pass> - Set room password (empty rooms only)', 'system');
                addMessage('system', '/notify - Enable desktop notifications', 'system');
                addMessage('system', '/copy - Copy all chat messages', 'system');
                addMessage('system', '/clear - Clear chat', 'system');
                addMessage('system', '/delete - Delete all chat messages for everyone', 'system');
                addMessage('system', '/room - Show room info', 'system');
                addMessage('system', 'Tap any message to add reaction.', 'system');
                addMessage('system', 'Colors: green, cyan, yellow, magenta, red, blue, orange, purple', 'system');
            } else if (text === '/emoji') {
                emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
            } else {
                sendMessage(username, text);
            }
        }
        
        function copyAllMessages() {
            const messageElements = messages.querySelectorAll('.message');
            let chatText = '';
            
            messageElements.forEach(msg => {
                // Extract text content without HTML tags
                const textContent = msg.textContent || msg.innerText;
                chatText += textContent + '\n';
            });
            
            if (chatText.trim()) {
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(chatText.trim()).then(() => {
                        addMessage('system', 'Chat copied to clipboard!', 'system');
                    }).catch(() => {
                        fallbackCopy(chatText.trim());
                    });
                } else {
                    fallbackCopy(chatText.trim());
                }
            } else {
                addMessage('system', 'No messages to copy', 'system');
            }
        }
        
        function fallbackCopy(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    addMessage('system', 'Chat copied to clipboard!', 'system');
                } else {
                    showCopyModal(text);
                }
            } catch (err) {
                showCopyModal(text);
            }
        }
        
        function showCopyModal(text) {
            // Create modal for manual copy
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: #111; border: 2px solid #00ff00; padding: 20px;
                max-width: 80%; max-height: 80%; overflow: auto;
                font-family: 'Courier New', monospace; color: #00ff00;
            `;
            
            const title = document.createElement('div');
            title.textContent = 'Copy Chat (Select All & Copy):';
            title.style.cssText = 'margin-bottom: 10px; color: #ffff00;';
            
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.cssText = `
                width: 100%; height: 300px; background: #000; color: #00ff00;
                border: 1px solid #333; font-family: 'Courier New', monospace;
                font-size: 12px; padding: 10px;
            `;
            textArea.readOnly = true;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = `
                margin-top: 10px; background: #333; color: #00ff00;
                border: 1px solid #00ff00; padding: 5px 15px;
                font-family: 'Courier New', monospace; cursor: pointer;
            `;
            
            closeBtn.onclick = () => document.body.removeChild(modal);
            modal.onclick = (e) => { if (e.target === modal) document.body.removeChild(modal); };
            
            content.appendChild(title);
            content.appendChild(textArea);
            content.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Auto-select text
            textArea.select();
            textArea.focus();
        }
        
        // Notification functions
        function requestNotificationPermission() {
            console.log('Requesting notification permission...');
            
            if (!('Notification' in window)) {
                addMessage('system', 'Browser does not support notifications', 'system');
                return;
            }
            
            console.log('Current permission:', Notification.permission);
            
            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                addMessage('system', 'Notifications already enabled!', 'system');
                // Test notification immediately
                showTestNotification();
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    console.log('Permission result:', permission);
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        addMessage('system', 'Notifications enabled! You\'ll get alerts when tab is not visible', 'system');
                        showTestNotification();
                    } else {
                        addMessage('system', 'Notifications denied', 'system');
                    }
                });
            } else {
                addMessage('system', 'Notifications blocked. Enable in browser settings.', 'system');
            }
        }
        
        function showTestNotification() {
            try {
                playNotificationSound();
                
                const notification = new Notification('Terminal Chat Test', {
                    body: 'Notifications are working! You\'ll get alerts for new messages.',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzAwZmYwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+SrDwvdGV4dD4KPHN2Zz4=',
                    tag: 'terminal-chat-test',
                    silent: false
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                setTimeout(() => notification.close(), 3000);
            } catch (error) {
                console.error('Test notification failed:', error);
                addMessage('system', 'Test notification failed: ' + error.message, 'system');
            }
        }
        
        function showNotification(user, text) {
            console.log('showNotification called:', user, text, 'Permission:', Notification.permission);
            
            if (notificationsEnabled && Notification.permission === 'granted') {
                try {
                    playNotificationSound();
                    
                    const notification = new Notification(`ðŸ’¬ ${user}`, {
                        body: text.length > 100 ? text.substring(0, 100) + '...' : text,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzAwZmYwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+SrDwvdGV4dD4KPHN2Zz4=',
                        tag: 'terminal-chat',
                        requireInteraction: false,
                        silent: false
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                    
                    // Auto-close after 5 seconds
                    setTimeout(() => notification.close(), 5000);
                    console.log('Notification created successfully');
                } catch (error) {
                    console.error('Notification failed:', error);
                    addMessage('system', 'Notification error: ' + error.message, 'system');
                }
            } else {
                console.log('Notification not shown - enabled:', notificationsEnabled, 'permission:', Notification.permission);
            }
        }
        
        function playNotificationSound() {
            try {
                // Create a simple beep sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
                console.log('Notification sound played');
            } catch (error) {
                console.log('Could not play notification sound:', error);
                // Fallback: try to play a simple audio element
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                    audio.volume = 0.3;
                    audio.play();
                } catch (e) {
                    console.log('Audio fallback also failed:', e);
                }
            }
        }
        
        // Page visibility detection
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
            console.log('Page visibility changed:', isPageVisible);
        });
        
        window.addEventListener('focus', () => {
            isPageVisible = true;
            console.log('Window focused');
        });
        
        window.addEventListener('blur', () => {
            isPageVisible = false;
            console.log('Window blurred');
        });
        
        // Prevent zoom on iOS
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });
        
        // Keep input focused on mobile
        input.addEventListener('touchend', () => {
            input.focus();
        });
        
        // Initial message
        addMessage('system', 'Commands: /nick, /color, /notify, /copy, /help', 'system');
    </script>
</body>
</html>
